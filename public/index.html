<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>Pong</title>
  <style>
    #screen {
      border: 10px solid #000000;
      padding-left: 0;
      padding-right: 0;
      margin-left: auto;
      margin-right: auto;
      display: block;
      width: 1280px;
      height: 720px;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <canvas id="screen" width="1280" height="720"></canvas>
  <script type="module">

    import renderScreen from "./render-screen.js"
    import createGame from "./game.js"
    import createKeyboardListener from './keyboard-listener.js'

    const game = createGame()
    const keyboardListener = createKeyboardListener(document)

    game.addBall(1, 640, 360, +1)
    game.addPlayer(1, 10, 315)
    game.addPlayer(2, 1250, 315)

    const socket = io()

    socket.on("connect", () => {
      const playerId = socket.id

      console.log(`Player connected on Client with id: ${playerId}`)
      const screen = document.getElementById('screen')
      renderScreen(screen, game, playerId)

    })

    socket.on("setup", (state) => {
      const playerId = socket.id
      game.setState(state)

      keyboardListener.registerPlayerId(playerId)
      keyboardListener.subscribe(game.movePlayer)
      keyboardListener.subscribe((command) => {
        socket.emit('move-player', command)
      })
    })

    socket.on('add-player', (command) => {
      console.log(`Receiving ${command.type} -> ${command.playerId}`)
      game.addPlayer(command)
    })

    socket.on('remove-player', (command) => {
      console.log(`Receiving ${command.type} -> ${command.playerId}`)
      game.removePlayer(command)
    })

    socket.on('move-player', (command) => {
      console.log(`Receiving ${command.type} -> ${command.playerId}`)
      const playerId = socket.id
      if (playerId !== command.playerId) {
        game.movePlayer(command)
      }
    })

    socket.on('add-ball', (command) => {
      console.log(`Receiving ${command.type} -> ${command.ballId}`)
      game.addBall(command)
    })

    socket.on('remove-ball', (command) => {
      console.log(`Receiving ${command.type} -> ${command.ballId}`)
      game.removeBall(command)
    })

    socket.on('move-ball', (command) => {
      console.log(`Receiving ${command.type} -> ${command.player2}`)
      game.removeBall(command)
    })

    socket.on('start', (command) => {
      console.log(`Receiving ${command.type} -> ${command.ballId}`)
      game.start(command)
    })



  </script>
</body>

</html>